name: Deploy PreProd

on:
  schedule:
    - cron: "0 12 * * *" 
  workflow_dispatch:  

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy HTML to Vercel (PreProd)
        run: |
          vercel deploy \
          --token ${{ secrets.VERCEL_TOKEN }} \
          --project ${{ secrets.VERCEL_PROJECT_PREPROD }} \
          --org ${{ secrets.VERCEL_ORG_ID }} \
          --yes

      - name: Run SQL migrations on Supabase (PreProd)
        run: |
          for file in resources/db/*.sql; do
            echo "Running file: $file"
            curl "${{ secrets.SUPABASE_URL_PREPROD }}/rest/v1/rpc/execute_sql" \
              -X POST \
              -H "apikey: ${{ secrets.SUPABASE_KEY_PREPROD }}" \
              -H "Content-Type: application/json" \
              -d "{\"query\":\"$(sed 's/"/\\"/g' $file)\"}"
          done
