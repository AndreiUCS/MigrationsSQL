name: Deploy Main

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy HTML to Vercel (Production)
        run: |
          vercel deploy --prod \
          --token ${{ secrets.VERCEL_TOKEN }} \
          --project ${{ secrets.VERCEL_PROJECT_PROD }} \
          --org ${{ secrets.VERCEL_ORG_ID }} \
          --yes

      - name: Run SQL migrations on Supabase (Prod)
        run: |
          for file in resources/db/*.sql; do
            echo "Running file: $file"
            curl "${{ secrets.SUPABASE_URL_PROD }}/rest/v1/rpc/execute_sql" \
              -X POST \
              -H "apikey: ${{ secrets.SUPABASE_KEY_PROD }}" \
              -H "Content-Type: application/json" \
              -d "{\"query\":\"$(sed 's/"/\\"/g' $file)\"}"
          done
